$(function () {
    function resetCaptcha(form, response) {
        form.find('input[name="captcha_word"]').val('');

        form.find('input[name="captcha_sid"]').val(response.captcha_code);
        form.find('img').attr('src', response.captcha_img);
    }

    $(document).on('click', '.js-popup-register .js-form-register [type="submit"]', function (ev) {
        ev.preventDefault();

        const $btn = $(this);
        const $form = $btn.closest('form');

        let fmData = new FormData($form[0]);

        const sessId = $form.data('sessid');

        fmData.append('sessid', sessId);
        fmData.append('js', 'ok');

        fmData.delete('agree');

        if ($form.find('[name="agree"]').is(':checked')) {
            fmData.append('agree', 'Y');
        } else {
            alert(window.BX.message('GET_AGREE'));
            return;
        }

        $.ajax({
            url: '/local/ajax/register.php',
            type: "POST",
            data: fmData,
            processData: false,
            contentType: false
        }).done(function (response) {
            if (response.status === 'ok') {
                setTimeout(function () {
                    location.reload(true);
                }, 1000);
            } else if (response.message) {
                app.showNotify(response.message);
                resetCaptcha($form, response);
            } else {
                app.showNotify('Произошла ошибка. Попробуйте еще раз.');
            }

        });
    });
});
